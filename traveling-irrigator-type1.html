<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Irrigation Set Polygon Map - Double Set Irrigator</title>

    <!-- Leaflet CSS -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""
    />

    <!-- Leaflet JavaScript -->
    <script
      src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
      crossorigin=""
    ></script>

    <style>
      body {
        margin: 0;
        padding: 0;
      }
      #map {
        width: 100%;
        height: 100vh;
      }
      .info-panel {
        padding: 10px;
        background: white;
        border-radius: 5px;
        box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
      }
      .info-panel h4 {
        margin: 0 0 5px;
        color: #555;
      }
      .leaflet-control-attribution {
        font-size: 8px !important;
        background-color: rgba(255, 255, 255, 0.3) !important;
        padding: 3px !important;
        opacity: 0.6;
      }
      .leaflet-control-attribution:hover {
        opacity: 1;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>

    <script>
      // Initialize the map
      const map = L.map("map", {
        zoomControl: true,
        attributionControl: true,
        zoomSnap: 0.25,
        zoomDelta: 0.25,
      }).setView([-21.213, 149.103], 16); // Centered between the two irrigation sets

      // Add satellite imagery layer
      const esriLayer = L.tileLayer(
        "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
        {
          maxZoom: 19,
          attribution:
            '<span style="font-size: 8px; opacity: 0.6;">Â© Esri &mdash; Esri Community</span>',
        }
      ).addTo(map);

      // Create left irrigation set polygon (unwatered style: same as type2)
      const leftSetCoordinates = [
        [-21.2155803060779, 149.10271167816677],
        [-21.211954676535424, 149.10317838192978],
        [-21.211999685256227, 149.10356462002792],
        [-21.215620333143892, 149.10308718679352],
        [-21.2155803060779, 149.10271167816677], // Close the polygon
      ];

      // Create right irrigation set polygon (unwatered style: same as type2)
      const rightSetCoordinates = [
        [-21.21563534437809, 149.10317301752173],
        [-21.212008335454467, 149.10364525156433],
        [-21.212044685264814, 149.10400450220715],
        [-21.215670353188735, 149.10352170460428],
        [-21.21563534437809, 149.10317301752173], // Close the polygon
      ];

      // Calculate the actual area of a polygon in hectares
      const calculatePolygonAreaInHectares = (coordinates) => {
        // Remove the last coordinate if it's the same as the first (closing point)
        const coords = coordinates.slice(0, -1);

        // Earth's radius in meters
        const R = 6371000;

        // Convert latitude and longitude from degrees to radians
        const radCoords = coords.map((coord) => [
          (coord[0] * Math.PI) / 180,
          (coord[1] * Math.PI) / 180,
        ]);

        // Calculate area using the Shoelace formula adapted for spherical coordinates
        let area = 0;
        for (let i = 0; i < radCoords.length; i++) {
          const j = (i + 1) % radCoords.length;

          // Calculate the area of the sector
          area +=
            (radCoords[j][1] - radCoords[i][1]) *
            Math.sin((radCoords[i][0] + radCoords[j][0]) / 2) *
            Math.cos((radCoords[i][0] - radCoords[j][0]) / 2);
        }

        // Multiply by Earth's radius squared to get the area in square meters
        area = Math.abs((area * R * R) / 2);

        // Convert to hectares (1 hectare = 10,000 square meters)
        return area / 10000;
      };

      // Calculate the areas in hectares
      const leftAreaInHectares =
        calculatePolygonAreaInHectares(leftSetCoordinates);
      const rightAreaInHectares =
        calculatePolygonAreaInHectares(rightSetCoordinates);
      const leftFormattedArea = leftAreaInHectares.toFixed(2);
      const rightFormattedArea = rightAreaInHectares.toFixed(2);

      const leftIrrigationPolygon = L.polygon(leftSetCoordinates, {
        color: "#007bff",
        weight: 2,
        opacity: 1,
        fillColor: "none",
        fillOpacity: 0.2,
      }).addTo(map);

      const rightIrrigationPolygon = L.polygon(rightSetCoordinates, {
        color: "#007bff",
        weight: 2,
        opacity: 1,
        fillColor: "none",
        fillOpacity: 0.2,
      }).addTo(map);

      // Add popups to the polygons
      leftIrrigationPolygon.bindPopup(`
        <div style="text-align: center; min-width: 200px;">
          <h4 style="margin: 5px 0;">Left Irrigation Set</h4>
          <div style="margin: 5px 0; font-size: 14px;">Coupled with: Right Set</div>
          <div style="margin: 10px 0;">
            <div style="margin-bottom: 10px;">
              <label for="leftOperationMode" style="display: block; margin-bottom: 5px; text-align: left;">Operation Mode:</label>
              <select id="leftOperationMode" style="width: 100%; padding: 5px; border-radius: 4px; border: 1px solid #ccc;">
                <option value="single">Single set</option>
                <option value="coupled">Coupled sets</option>
              </select>
            </div>
            <label class="switch" style="position: relative; display: inline-block; width: 60px; height: 30px;">
              <input type="checkbox" id="leftIrrigationToggle" style="opacity: 0; width: 0; height: 0;">
              <span style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px;"></span>
            </label>
            <div style="margin-top: 5px;">Irrigation: <span id="leftIrrigationStatus">OFF</span></div>
          </div>
        </div>
      `);

      rightIrrigationPolygon.bindPopup(`
        <div style="text-align: center; min-width: 200px;">
          <h4 style="margin: 5px 0;">Right Irrigation Set</h4>
          <div style="margin: 5px 0; font-size: 14px;">Coupled with: Left Set</div>
          <div style="margin: 10px 0;">
            <div style="margin-bottom: 10px;">
              <label for="rightOperationMode" style="display: block; margin-bottom: 5px; text-align: left;">Operation Mode:</label>
              <select id="rightOperationMode" style="width: 100%; padding: 5px; border-radius: 4px; border: 1px solid #ccc;">
                <option value="single">Single set</option>
                <option value="coupled">Coupled sets</option>
              </select>
            </div>
            <label class="switch" style="position: relative; display: inline-block; width: 60px; height: 30px;">
              <input type="checkbox" id="rightIrrigationToggle" style="opacity: 0; width: 0; height: 0;">
              <span style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px;"></span>
            </label>
            <div style="margin-top: 5px;">Irrigation: <span id="rightIrrigationStatus">OFF</span></div>
          </div>
        </div>
      `);

      // Group both polygons for a proper fit
      const irrigationGroup = L.featureGroup([
        leftIrrigationPolygon,
        rightIrrigationPolygon,
      ]);
      map.fitBounds(irrigationGroup.getBounds(), {
        padding: [50, 50], // Add 50 pixels of padding on all sides
      });

      // Info panel
      const info = L.control();
      info.onAdd = function (map) {
        this._div = L.DomUtil.create("div", "info-panel");
        this.update();
        return this._div;
      };
      info.update = function () {
        this._div.innerHTML =
          "<h4>Irrigation Sets Information</h4>" +
          "Left Set Area: " +
          leftFormattedArea +
          " hectares<br>" +
          "Right Set Area: " +
          rightFormattedArea +
          " hectares<br>" +
          "Type: Dual Sets<br>" +
          "Status: Active";
      };
      info.addTo(map);

      // Define irrigator travel path between the two sets
      // Using exact coordinates provided
      const startPoint = [-21.215625, 149.103133];
      // End point
      const endPoint = [-21.2120105, 149.1035915];

      // Draw a faint line showing the path
      const irrigatorPath = [startPoint, endPoint];
      const pathLine = L.polyline(irrigatorPath, {
        color: "#555555",
        weight: 1,
        opacity: 0.5,
        dashArray: "3, 3",
      }).addTo(map);

      // Custom irrigator icon with sprinklers on both sides
      const irrigatorIcon = L.divIcon({
        className: "irrigator-icon",
        html: `
          <svg width="60" height="40" viewBox="0 0 60 40" xmlns="http://www.w3.org/2000/svg">
            <!-- Main irrigator vehicle body -->
            <rect x="20" y="15" width="20" height="10" rx="2" fill="#2c3e50" stroke="#333333" stroke-width="1" />
            
            <!-- Wheels -->
            <circle cx="23" cy="25" r="3" fill="#555555" stroke="#333333" stroke-width="0.5" />
            <circle cx="37" cy="25" r="3" fill="#555555" stroke="#333333" stroke-width="0.5" />
            
            <!-- Left arm with sprinklers -->
            <rect x="5" y="18" width="15" height="4" rx="1" fill="#3498db" stroke="#333333" stroke-width="0.5" />
            
            <!-- Right arm with sprinklers -->
            <rect x="40" y="18" width="15" height="4" rx="1" fill="#3498db" stroke="#333333" stroke-width="0.5" />
            
            <!-- Left sprinklers -->
            <circle cx="8" cy="20" r="1.5" fill="white" stroke="#cccccc" stroke-width="0.5" class="sprinkler" />
            <circle cx="15" cy="20" r="1.5" fill="white" stroke="#cccccc" stroke-width="0.5" class="sprinkler" />
            
            <!-- Right sprinklers -->
            <circle cx="45" cy="20" r="1.5" fill="white" stroke="#cccccc" stroke-width="0.5" class="sprinkler" />
            <circle cx="52" cy="20" r="1.5" fill="white" stroke="#cccccc" stroke-width="0.5" class="sprinkler" />
            
            <!-- Water spray for left and right sides (separated) -->
            <!-- Left sprinkler sprays -->
            <g class="water-spray left-spray">
              <path d="M8,20 Q8,15 8,12" stroke="#ffffff" stroke-width="0.8" fill="none" stroke-dasharray="1,1" />
              <path d="M8,20 Q5,15 3,12" stroke="#ffffff" stroke-width="0.8" fill="none" stroke-dasharray="1,1" />
              <path d="M8,20 Q11,15 13,12" stroke="#ffffff" stroke-width="0.8" fill="none" stroke-dasharray="1,1" />
              
              <path d="M15,20 Q15,15 15,12" stroke="#ffffff" stroke-width="0.8" fill="none" stroke-dasharray="1,1" />
              <path d="M15,20 Q12,15 10,12" stroke="#ffffff" stroke-width="0.8" fill="none" stroke-dasharray="1,1" />
              <path d="M15,20 Q18,15 20,12" stroke="#ffffff" stroke-width="0.8" fill="none" stroke-dasharray="1,1" />
            </g>
              
            <!-- Right sprinkler sprays -->
            <g class="water-spray right-spray">
              <path d="M45,20 Q45,15 45,12" stroke="#ffffff" stroke-width="0.8" fill="none" stroke-dasharray="1,1" />
              <path d="M45,20 Q42,15 40,12" stroke="#ffffff" stroke-width="0.8" fill="none" stroke-dasharray="1,1" />
              <path d="M45,20 Q48,15 50,12" stroke="#ffffff" stroke-width="0.8" fill="none" stroke-dasharray="1,1" />
              
              <path d="M52,20 Q52,15 52,12" stroke="#ffffff" stroke-width="0.8" fill="none" stroke-dasharray="1,1" />
              <path d="M52,20 Q49,15 47,12" stroke="#ffffff" stroke-width="0.8" fill="none" stroke-dasharray="1,1" />
              <path d="M52,20 Q55,15 57,12" stroke="#ffffff" stroke-width="0.8" fill="none" stroke-dasharray="1,1" />
            </g>
          </svg>
        `,
        iconSize: [60, 40],
        iconAnchor: [30, 20],
      });

      // Create the irrigator marker
      const irrigator = L.marker(startPoint, {
        icon: irrigatorIcon,
        zIndexOffset: 1000,
      }).addTo(map);

      // Calculate the angle of the path for proper vehicle orientation
      const calculateAngle = (point1, point2) => {
        const dx = point2[1] - point1[1]; // Longitude difference
        const dy = point2[0] - point1[0]; // Latitude difference
        let angle = Math.atan2(dx, dy) * (180 / Math.PI);
        return angle;
      };

      // Initial angle of the path
      const pathAngle = calculateAngle(startPoint, endPoint);

      // Apply initial rotation to irrigator icon
      setTimeout(() => {
        const irrigatorElement = document.querySelector(".irrigator-icon svg");
        if (irrigatorElement) {
          irrigatorElement.style.transform = `rotate(${pathAngle}deg)`;
          irrigatorElement.style.transformOrigin = "center center";
        }
      }, 100);

      // Sprinkler spray animation
      const sprinklerAnimation = document.createElement("style");
      sprinklerAnimation.textContent = `
        @keyframes spray {
          0% { opacity: 0.3; }
          50% { opacity: 0.9; }
          100% { opacity: 0.3; }
        }
        .water-spray {
          animation: spray 1.5s infinite;
          filter: drop-shadow(0 0 1.5px rgba(255, 255, 255, 0.8));
        }
        /* Hide both sprays by default */
        .left-spray, .right-spray {
          opacity: 0;
          display: none;
        }
        /* Classes to show specific sprays when active */
        .left-irrigation-active .left-spray {
          opacity: 1;
          display: block;
        }
        .right-irrigation-active .right-spray {
          opacity: 1;
          display: block;
        }
        .irrigator-icon {
          z-index: 1000;
          filter: drop-shadow(0 0 3px rgba(0, 0, 0, 0.4));
        }
        .sprinkler {
          filter: drop-shadow(0 0 1px rgba(255, 255, 255, 0.7));
        }
      `;
      document.head.appendChild(sprinklerAnimation);

      // Create SVG gradient and water pattern definition (same as type2)
      const svgDefs = document.createElementNS(
        "http://www.w3.org/2000/svg",
        "svg"
      );
      svgDefs.setAttribute("width", "0");
      svgDefs.setAttribute("height", "0");
      svgDefs.innerHTML = `
        <defs>
          <!-- Water pattern for the irrigated areas -->
          <pattern id="water-pattern" x="0" y="0" width="10" height="10" patternUnits="userSpaceOnUse">
            <!-- Transparent base with wave lines -->
            <rect x="0" y="0" width="10" height="10" fill="none" fill-opacity="0.5" />
            <path d="M0,5 Q2.5,3 5,5 T10,5" fill="none" stroke="#a8d8ea" stroke-width="0.5" opacity="0.4" />
            <path d="M0,7.5 Q2.5,5.5 5,7.5 T10,7.5" fill="none" stroke="#a8d8ea" stroke-width="0.5" opacity="0.4" />
            <path d="M0,2.5 Q2.5,0.5 5,2.5 T10,2.5" fill="none" stroke="#a8d8ea" stroke-width="0.5" opacity="0.4" />
          </pattern>
          
          <!-- Blue water pattern for watered areas -->
          <pattern id="blue-water-pattern" x="0" y="0" width="10" height="10" patternUnits="userSpaceOnUse">
            <!-- Blue base with wave lines -->
            <rect x="0" y="0" width="10" height="10" fill="#4BB4E6" fill-opacity="0.7" />
            <path d="M0,5 Q2.5,3 5,5 T10,5" fill="none" stroke="white" stroke-width="0.5" opacity="0.4" />
            <path d="M0,7.5 Q2.5,5.5 5,7.5 T10,7.5" fill="none" stroke="white" stroke-width="0.5" opacity="0.4" />
            <path d="M0,2.5 Q2.5,0.5 5,2.5 T10,2.5" fill="none" stroke="white" stroke-width="0.5" opacity="0.4" />
          </pattern>
        </defs>
      `;
      document.body.appendChild(svgDefs);

      // Update the unwatered irrigation set polygons to show the wave pattern
      leftIrrigationPolygon.setStyle({
        fillColor: "none",
        fillOpacity: 0.2,
      });

      rightIrrigationPolygon.setStyle({
        fillColor: "none",
        fillOpacity: 0.2,
      });

      // Create watered areas for left and right sets
      const wateredAreaStyle = {
        color: "#4BB4E6",
        fillColor: "url(#blue-water-pattern)",
        fillOpacity: 1,
        weight: 1.5,
        className: "watered-area",
      };

      const leftWateredArea = L.polygon(
        [
          leftSetCoordinates[3], // D
          leftSetCoordinates[0], // A
          leftSetCoordinates[0], // A (no area)
          leftSetCoordinates[3], // D (no area)
        ],
        wateredAreaStyle
      ).addTo(map);

      const rightWateredArea = L.polygon(
        [
          rightSetCoordinates[0],
          rightSetCoordinates[3],
          rightSetCoordinates[3],
          rightSetCoordinates[0],
        ],
        wateredAreaStyle
      ).addTo(map);

      // Add style for watered-area polygons
      const waterStyle = document.createElement("style");
      waterStyle.textContent = `
        .watered-area {
          filter: drop-shadow(0 0 2px rgba(75, 180, 230, 0.4));
        }
      `;
      document.head.appendChild(waterStyle);

      // Apply the wave pattern to all irrigation polygons
      setTimeout(() => {
        // Apply pattern to unwatered irrigation polygons
        document
          .querySelectorAll('.leaflet-overlay-pane svg path[stroke="#007bff"]')
          .forEach((path) => {
            path.setAttribute("fill", "url(#water-pattern)");
            path.setAttribute("fill-opacity", "0.2");
          });
      }, 100);

      // Add style for toggle switches
      const toggleStyle = document.createElement("style");
      toggleStyle.textContent = `
        .switch input:checked + span {
          background-color: #4BB4E6;
        }
        .switch span:before {
          position: absolute;
          content: "";
          height: 22px;
          width: 22px;
          left: 4px;
          bottom: 4px;
          background-color: white;
          transition: .4s;
          border-radius: 50%;
        }
        .switch input:checked + span:before {
          transform: translateX(30px);
        }
      `;
      document.head.appendChild(toggleStyle);

      // Controls
      const controlPanel = L.control({ position: "bottomleft" });
      controlPanel.onAdd = function (map) {
        const div = L.DomUtil.create("div", "control-panel");
        div.style.backgroundColor = "white";
        div.style.padding = "10px";
        div.style.borderRadius = "5px";
        div.style.boxShadow = "0 0 15px rgba(0,0,0,0.2)";
        div.innerHTML = `
          <h4 style="margin-top: 0;">Dual Set Irrigator Controls</h4>
          <button id="resetAnimation" style="padding: 5px 10px; background-color: #f8f9fa; color: #333; border: 1px solid #ddd; border-radius: 3px; cursor: pointer;">Reset All</button>
        `;
        return div;
      };
      controlPanel.addTo(map);

      // Animation logic
      let animationInterval;
      let irrigatorMoveInterval;
      const animationDuration = 10000; // 10 seconds
      const fps = 30;
      const steps = animationDuration / (1000 / fps);
      let currentStep = 0;
      let leftIrrigationActive = false;
      let rightIrrigationActive = false;
      let leftOperationMode = "single";
      let rightOperationMode = "single";
      let irrigatorMoving = false;
      let irrigatorAtStart = true; // Track irrigator position (start at the start point)

      // Linear interpolation helper
      const lerp = (start, end, t) => start + t * (end - start);

      // Function to move irrigator along the path
      const moveIrrigator = () => {
        if (irrigatorMoving) return;

        irrigatorMoving = true;
        currentStep = 0;

        // Determine direction based on current position
        const fromStartToEnd = irrigatorAtStart;

        // Set correct rotation
        const moveAngle = fromStartToEnd ? pathAngle : (pathAngle + 180) % 360;
        setTimeout(() => {
          const irrigatorElement = document.querySelector(
            ".irrigator-icon svg"
          );
          if (irrigatorElement) {
            irrigatorElement.style.transform = `rotate(${moveAngle}deg)`;
            irrigatorElement.style.transformOrigin = "center center";
          }
        }, 10);

        // Start movement animation
        if (irrigatorMoveInterval) clearInterval(irrigatorMoveInterval);

        irrigatorMoveInterval = setInterval(function () {
          currentStep++;
          if (currentStep <= steps) {
            const progress = currentStep / steps;

            // Current irrigator position
            const currentPosition = fromStartToEnd
              ? [
                  lerp(startPoint[0], endPoint[0], progress),
                  lerp(startPoint[1], endPoint[1], progress),
                ]
              : [
                  lerp(endPoint[0], startPoint[0], progress),
                  lerp(endPoint[1], startPoint[1], progress),
                ];

            irrigator.setLatLng(currentPosition);

            // Keep correct rotation
            setTimeout(() => {
              const irrigatorElement = document.querySelector(
                ".irrigator-icon svg"
              );
              if (irrigatorElement) {
                irrigatorElement.style.transform = `rotate(${moveAngle}deg)`;
                irrigatorElement.style.transformOrigin = "center center";
              }
            }, 10);
          } else {
            clearInterval(irrigatorMoveInterval);
            irrigatorMoving = false;

            // Update irrigator position tracking
            irrigatorAtStart = !irrigatorAtStart;
          }
        }, 1000 / fps);
      };

      // Function to start the left irrigation animation
      const startLeftIrrigation = () => {
        leftIrrigationActive = true;

        // If in coupled mode, also activate right irrigation
        if (leftOperationMode === "coupled" && !rightIrrigationActive) {
          rightIrrigationActive = true;
          rightWateredArea.setStyle({ fillOpacity: 0.7 });

          // Update right toggle if popup is open
          const rightToggle = document.getElementById("rightIrrigationToggle");
          if (rightToggle) {
            rightToggle.checked = true;
            document.getElementById("rightIrrigationStatus").textContent = "ON";
          }

          // Show right sprinkler animation
          const irrigatorElement = document.querySelector(".irrigator-icon");
          if (irrigatorElement) {
            irrigatorElement.classList.add("right-irrigation-active");
          }
        }

        // Start moving irrigator based on its current position
        if (!irrigatorMoving) {
          moveIrrigator();
        }

        // Fade watered area in
        leftWateredArea.setStyle({ fillOpacity: 0.7 });

        // Show left sprinkler animation
        const irrigatorElement = document.querySelector(".irrigator-icon");
        if (irrigatorElement) {
          irrigatorElement.classList.add("left-irrigation-active");
        }

        // Animate the watered area expansion
        currentStep = 0;
        if (animationInterval) clearInterval(animationInterval);

        // Determine the direction of water flow based on irrigator position
        const flowFromStartToEnd = irrigatorAtStart;

        animationInterval = setInterval(function () {
          currentStep++;
          if (currentStep <= steps) {
            const progress = currentStep / steps;

            // For left set: direction of expansion depends on irrigator position
            let leftWateredAreaCoords;

            if (flowFromStartToEnd) {
              // Irrigator is at start, water flows from start to end (D-A to C-B)
              leftWateredAreaCoords = [
                leftSetCoordinates[3], // D
                leftSetCoordinates[0], // A
                [
                  lerp(
                    leftSetCoordinates[0][0],
                    leftSetCoordinates[1][0],
                    progress
                  ),
                  lerp(
                    leftSetCoordinates[0][1],
                    leftSetCoordinates[1][1],
                    progress
                  ),
                ],
                [
                  lerp(
                    leftSetCoordinates[3][0],
                    leftSetCoordinates[2][0],
                    progress
                  ),
                  lerp(
                    leftSetCoordinates[3][1],
                    leftSetCoordinates[2][1],
                    progress
                  ),
                ],
              ];
            } else {
              // Irrigator is at end, water flows from end to start (C-B to D-A)
              leftWateredAreaCoords = [
                [
                  lerp(
                    leftSetCoordinates[2][0],
                    leftSetCoordinates[3][0],
                    progress
                  ),
                  lerp(
                    leftSetCoordinates[2][1],
                    leftSetCoordinates[3][1],
                    progress
                  ),
                ],
                [
                  lerp(
                    leftSetCoordinates[1][0],
                    leftSetCoordinates[0][0],
                    progress
                  ),
                  lerp(
                    leftSetCoordinates[1][1],
                    leftSetCoordinates[0][1],
                    progress
                  ),
                ],
                leftSetCoordinates[1], // B
                leftSetCoordinates[2], // C
              ];
            }

            leftWateredArea.setLatLngs(leftWateredAreaCoords);

            // If in coupled mode, also animate right set
            if (leftOperationMode === "coupled") {
              let rightWateredAreaCoords;

              if (flowFromStartToEnd) {
                // Irrigator is at start, water flows from start to end
                rightWateredAreaCoords = [
                  rightSetCoordinates[0],
                  rightSetCoordinates[3],
                  [
                    lerp(
                      rightSetCoordinates[3][0],
                      rightSetCoordinates[2][0],
                      progress
                    ),
                    lerp(
                      rightSetCoordinates[3][1],
                      rightSetCoordinates[2][1],
                      progress
                    ),
                  ],
                  [
                    lerp(
                      rightSetCoordinates[0][0],
                      rightSetCoordinates[1][0],
                      progress
                    ),
                    lerp(
                      rightSetCoordinates[0][1],
                      rightSetCoordinates[1][1],
                      progress
                    ),
                  ],
                ];
              } else {
                // Irrigator is at end, water flows from end to start
                rightWateredAreaCoords = [
                  [
                    lerp(
                      rightSetCoordinates[1][0],
                      rightSetCoordinates[0][0],
                      progress
                    ),
                    lerp(
                      rightSetCoordinates[1][1],
                      rightSetCoordinates[0][1],
                      progress
                    ),
                  ],
                  [
                    lerp(
                      rightSetCoordinates[2][0],
                      rightSetCoordinates[3][0],
                      progress
                    ),
                    lerp(
                      rightSetCoordinates[2][1],
                      rightSetCoordinates[3][1],
                      progress
                    ),
                  ],
                  rightSetCoordinates[2],
                  rightSetCoordinates[1],
                ];
              }

              rightWateredArea.setLatLngs(rightWateredAreaCoords);
            }
          } else {
            clearInterval(animationInterval);
          }
        }, 1000 / fps);
      };

      // Function to start the right irrigation animation
      const startRightIrrigation = () => {
        rightIrrigationActive = true;

        // If in coupled mode, also activate left irrigation
        if (rightOperationMode === "coupled" && !leftIrrigationActive) {
          leftIrrigationActive = true;
          leftWateredArea.setStyle({ fillOpacity: 0.7 });

          // Update left toggle if popup is open
          const leftToggle = document.getElementById("leftIrrigationToggle");
          if (leftToggle) {
            leftToggle.checked = true;
            document.getElementById("leftIrrigationStatus").textContent = "ON";
          }

          // Show left sprinkler animation
          const irrigatorElement = document.querySelector(".irrigator-icon");
          if (irrigatorElement) {
            irrigatorElement.classList.add("left-irrigation-active");
          }
        }

        // Start moving irrigator based on its current position
        if (!irrigatorMoving) {
          moveIrrigator();
        }

        // Fade watered area in
        rightWateredArea.setStyle({ fillOpacity: 0.7 });

        // Show right sprinkler animation
        const irrigatorElement = document.querySelector(".irrigator-icon");
        if (irrigatorElement) {
          irrigatorElement.classList.add("right-irrigation-active");
        }

        // Animate the watered area expansion
        currentStep = 0;
        if (animationInterval) clearInterval(animationInterval);

        // Determine the direction of water flow based on irrigator position
        const flowFromStartToEnd = irrigatorAtStart;

        animationInterval = setInterval(function () {
          currentStep++;
          if (currentStep <= steps) {
            const progress = currentStep / steps;

            // For right set: direction of expansion depends on irrigator position
            let rightWateredAreaCoords;

            if (flowFromStartToEnd) {
              // Irrigator is at start, water flows from start to end
              rightWateredAreaCoords = [
                rightSetCoordinates[0],
                rightSetCoordinates[3],
                [
                  lerp(
                    rightSetCoordinates[3][0],
                    rightSetCoordinates[2][0],
                    progress
                  ),
                  lerp(
                    rightSetCoordinates[3][1],
                    rightSetCoordinates[2][1],
                    progress
                  ),
                ],
                [
                  lerp(
                    rightSetCoordinates[0][0],
                    rightSetCoordinates[1][0],
                    progress
                  ),
                  lerp(
                    rightSetCoordinates[0][1],
                    rightSetCoordinates[1][1],
                    progress
                  ),
                ],
              ];
            } else {
              // Irrigator is at end, water flows from end to start
              rightWateredAreaCoords = [
                [
                  lerp(
                    rightSetCoordinates[1][0],
                    rightSetCoordinates[0][0],
                    progress
                  ),
                  lerp(
                    rightSetCoordinates[1][1],
                    rightSetCoordinates[0][1],
                    progress
                  ),
                ],
                [
                  lerp(
                    rightSetCoordinates[2][0],
                    rightSetCoordinates[3][0],
                    progress
                  ),
                  lerp(
                    rightSetCoordinates[2][1],
                    rightSetCoordinates[3][1],
                    progress
                  ),
                ],
                rightSetCoordinates[2],
                rightSetCoordinates[1],
              ];
            }

            rightWateredArea.setLatLngs(rightWateredAreaCoords);

            // If in coupled mode, also animate left set
            if (rightOperationMode === "coupled") {
              let leftWateredAreaCoords;

              if (flowFromStartToEnd) {
                // Irrigator is at start, water flows from start to end
                leftWateredAreaCoords = [
                  leftSetCoordinates[3], // D
                  leftSetCoordinates[0], // A
                  [
                    lerp(
                      leftSetCoordinates[0][0],
                      leftSetCoordinates[1][0],
                      progress
                    ),
                    lerp(
                      leftSetCoordinates[0][1],
                      leftSetCoordinates[1][1],
                      progress
                    ),
                  ],
                  [
                    lerp(
                      leftSetCoordinates[3][0],
                      leftSetCoordinates[2][0],
                      progress
                    ),
                    lerp(
                      leftSetCoordinates[3][1],
                      leftSetCoordinates[2][1],
                      progress
                    ),
                  ],
                ];
              } else {
                // Irrigator is at end, water flows from end to start
                leftWateredAreaCoords = [
                  [
                    lerp(
                      leftSetCoordinates[2][0],
                      leftSetCoordinates[3][0],
                      progress
                    ),
                    lerp(
                      leftSetCoordinates[2][1],
                      leftSetCoordinates[3][1],
                      progress
                    ),
                  ],
                  [
                    lerp(
                      leftSetCoordinates[1][0],
                      leftSetCoordinates[0][0],
                      progress
                    ),
                    lerp(
                      leftSetCoordinates[1][1],
                      leftSetCoordinates[0][1],
                      progress
                    ),
                  ],
                  leftSetCoordinates[1], // B
                  leftSetCoordinates[2], // C
                ];
              }

              leftWateredArea.setLatLngs(leftWateredAreaCoords);
            }
          } else {
            clearInterval(animationInterval);
          }
        }, 1000 / fps);
      };

      // Function to stop the left irrigation
      const stopLeftIrrigation = () => {
        leftIrrigationActive = false;

        // Hide left sprinkler animation
        const irrigatorElement = document.querySelector(".irrigator-icon");
        if (irrigatorElement) {
          irrigatorElement.classList.remove("left-irrigation-active");
        }

        // Reset watered area based on irrigator position
        let resetLeftWateredAreaCoords;

        if (irrigatorAtStart) {
          // Reset to start side
          resetLeftWateredAreaCoords = [
            leftSetCoordinates[3], // D
            leftSetCoordinates[0], // A
            leftSetCoordinates[0], // A (no area)
            leftSetCoordinates[3], // D (no area)
          ];
        } else {
          // Reset to end side
          resetLeftWateredAreaCoords = [
            leftSetCoordinates[2], // C
            leftSetCoordinates[1], // B
            leftSetCoordinates[1], // B (no area)
            leftSetCoordinates[2], // C (no area)
          ];
        }

        leftWateredArea.setLatLngs(resetLeftWateredAreaCoords);
        leftWateredArea.setStyle({ fillOpacity: 0 });

        // If in coupled mode, also stop right irrigation
        if (leftOperationMode === "coupled" && rightIrrigationActive) {
          stopRightIrrigation();

          // Update right toggle if popup is open
          const rightToggle = document.getElementById("rightIrrigationToggle");
          if (rightToggle) {
            rightToggle.checked = false;
            document.getElementById("rightIrrigationStatus").textContent =
              "OFF";
          }
        }

        // Stop irrigator movement if both sets are inactive
        if (!rightIrrigationActive && irrigatorMoving) {
          clearInterval(irrigatorMoveInterval);
          irrigatorMoving = false;
        }
      };

      // Function to stop the right irrigation
      const stopRightIrrigation = () => {
        rightIrrigationActive = false;

        // Hide right sprinkler animation
        const irrigatorElement = document.querySelector(".irrigator-icon");
        if (irrigatorElement) {
          irrigatorElement.classList.remove("right-irrigation-active");
        }

        // Reset watered area based on irrigator position
        let resetRightWateredAreaCoords;

        if (irrigatorAtStart) {
          // Reset to start side
          resetRightWateredAreaCoords = [
            rightSetCoordinates[0],
            rightSetCoordinates[3],
            rightSetCoordinates[3],
            rightSetCoordinates[0],
          ];
        } else {
          // Reset to end side
          resetRightWateredAreaCoords = [
            rightSetCoordinates[1],
            rightSetCoordinates[2],
            rightSetCoordinates[2],
            rightSetCoordinates[1],
          ];
        }

        rightWateredArea.setLatLngs(resetRightWateredAreaCoords);
        rightWateredArea.setStyle({ fillOpacity: 0 });

        // If in coupled mode, also stop left irrigation
        if (rightOperationMode === "coupled" && leftIrrigationActive) {
          stopLeftIrrigation();

          // Update left toggle if popup is open
          const leftToggle = document.getElementById("leftIrrigationToggle");
          if (leftToggle) {
            leftToggle.checked = false;
            document.getElementById("leftIrrigationStatus").textContent = "OFF";
          }
        }

        // Stop irrigator movement if both sets are inactive
        if (!leftIrrigationActive && irrigatorMoving) {
          clearInterval(irrigatorMoveInterval);
          irrigatorMoving = false;
        }
      };

      // Event listeners for toggle switches
      map.on("popupopen", function (e) {
        // Check if it's the left irrigation popup
        const leftToggle = document.getElementById("leftIrrigationToggle");
        const leftModeSelect = document.getElementById("leftOperationMode");

        if (leftToggle && leftModeSelect) {
          // Set current values
          leftToggle.checked = leftIrrigationActive;
          document.getElementById("leftIrrigationStatus").textContent =
            leftIrrigationActive ? "ON" : "OFF";
          leftModeSelect.value = leftOperationMode;

          // Add event listeners
          leftToggle.addEventListener("change", function () {
            if (this.checked) {
              startLeftIrrigation();
              document.getElementById("leftIrrigationStatus").textContent =
                "ON";
            } else {
              // Perform full reset (same as Reset All button)
              // Clear any existing animation
              if (animationInterval) clearInterval(animationInterval);
              if (irrigatorMoveInterval) clearInterval(irrigatorMoveInterval);
              irrigatorMoving = false;

              // Reset irrigator
              irrigator.setLatLng(startPoint);
              irrigatorAtStart = true; // Reset position tracking

              setTimeout(() => {
                const irrigatorElement = document.querySelector(
                  ".irrigator-icon svg"
                );
                if (irrigatorElement) {
                  irrigatorElement.style.transform = `rotate(${pathAngle}deg)`;
                  irrigatorElement.style.transformOrigin = "center center";
                }
              }, 10);

              // Reset watered areas to zero at the start position
              leftIrrigationActive = false;
              rightIrrigationActive = false;

              // Hide both sprinkler animations
              const irrigatorIconElement =
                document.querySelector(".irrigator-icon");
              if (irrigatorIconElement) {
                irrigatorIconElement.classList.remove(
                  "left-irrigation-active",
                  "right-irrigation-active"
                );
              }

              // Reset left watered area to start position
              const resetLeftWateredAreaCoords = [
                leftSetCoordinates[3], // D
                leftSetCoordinates[0], // A
                leftSetCoordinates[0], // A (no area)
                leftSetCoordinates[3], // D (no area)
              ];
              leftWateredArea.setLatLngs(resetLeftWateredAreaCoords);
              leftWateredArea.setStyle({ fillOpacity: 0 });

              // Reset right watered area to start position
              const resetRightWateredAreaCoords = [
                rightSetCoordinates[0],
                rightSetCoordinates[3],
                rightSetCoordinates[3],
                rightSetCoordinates[0],
              ];
              rightWateredArea.setLatLngs(resetRightWateredAreaCoords);
              rightWateredArea.setStyle({ fillOpacity: 0 });

              currentStep = 0;

              // Update right toggle if popup is open
              const rightToggle = document.getElementById(
                "rightIrrigationToggle"
              );
              if (rightToggle) {
                rightToggle.checked = false;
                document.getElementById("rightIrrigationStatus").textContent =
                  "OFF";
              }

              document.getElementById("leftIrrigationStatus").textContent =
                "OFF";
            }
          });

          leftModeSelect.addEventListener("change", function () {
            leftOperationMode = this.value;

            // If switching to coupled mode and irrigation is active, activate the other set too
            if (
              leftOperationMode === "coupled" &&
              leftIrrigationActive &&
              !rightIrrigationActive
            ) {
              rightIrrigationActive = true;
              startRightIrrigation();
            }
          });
        }

        // Check if it's the right irrigation popup
        const rightToggle = document.getElementById("rightIrrigationToggle");
        const rightModeSelect = document.getElementById("rightOperationMode");

        if (rightToggle && rightModeSelect) {
          // Set current values
          rightToggle.checked = rightIrrigationActive;
          document.getElementById("rightIrrigationStatus").textContent =
            rightIrrigationActive ? "ON" : "OFF";
          rightModeSelect.value = rightOperationMode;

          // Add event listeners
          rightToggle.addEventListener("change", function () {
            if (this.checked) {
              startRightIrrigation();
              document.getElementById("rightIrrigationStatus").textContent =
                "ON";
            } else {
              // Perform full reset (same as Reset All button)
              // Clear any existing animation
              if (animationInterval) clearInterval(animationInterval);
              if (irrigatorMoveInterval) clearInterval(irrigatorMoveInterval);
              irrigatorMoving = false;

              // Reset irrigator
              irrigator.setLatLng(startPoint);
              irrigatorAtStart = true; // Reset position tracking

              setTimeout(() => {
                const irrigatorElement = document.querySelector(
                  ".irrigator-icon svg"
                );
                if (irrigatorElement) {
                  irrigatorElement.style.transform = `rotate(${pathAngle}deg)`;
                  irrigatorElement.style.transformOrigin = "center center";
                }
              }, 10);

              // Reset watered areas to zero at the start position
              leftIrrigationActive = false;
              rightIrrigationActive = false;

              // Hide both sprinkler animations
              const irrigatorIconElement =
                document.querySelector(".irrigator-icon");
              if (irrigatorIconElement) {
                irrigatorIconElement.classList.remove(
                  "left-irrigation-active",
                  "right-irrigation-active"
                );
              }

              // Reset left watered area to start position
              const resetLeftWateredAreaCoords = [
                leftSetCoordinates[3], // D
                leftSetCoordinates[0], // A
                leftSetCoordinates[0], // A (no area)
                leftSetCoordinates[3], // D (no area)
              ];
              leftWateredArea.setLatLngs(resetLeftWateredAreaCoords);
              leftWateredArea.setStyle({ fillOpacity: 0 });

              // Reset right watered area to start position
              const resetRightWateredAreaCoords = [
                rightSetCoordinates[0],
                rightSetCoordinates[3],
                rightSetCoordinates[3],
                rightSetCoordinates[0],
              ];
              rightWateredArea.setLatLngs(resetRightWateredAreaCoords);
              rightWateredArea.setStyle({ fillOpacity: 0 });

              currentStep = 0;

              // Update left toggle if popup is open
              const leftToggle = document.getElementById(
                "leftIrrigationToggle"
              );
              if (leftToggle) {
                leftToggle.checked = false;
                document.getElementById("leftIrrigationStatus").textContent =
                  "OFF";
              }

              document.getElementById("rightIrrigationStatus").textContent =
                "OFF";
            }
          });

          rightModeSelect.addEventListener("change", function () {
            rightOperationMode = this.value;

            // If switching to coupled mode and irrigation is active, activate the other set too
            if (
              rightOperationMode === "coupled" &&
              rightIrrigationActive &&
              !leftIrrigationActive
            ) {
              leftIrrigationActive = true;
              startLeftIrrigation();
            }
          });
        }
      });

      document
        .getElementById("resetAnimation")
        .addEventListener("click", function () {
          // Clear any existing animation
          if (animationInterval) clearInterval(animationInterval);
          if (irrigatorMoveInterval) clearInterval(irrigatorMoveInterval);
          irrigatorMoving = false;

          // Reset irrigator
          irrigator.setLatLng(startPoint);
          irrigatorAtStart = true; // Reset position tracking

          setTimeout(() => {
            const irrigatorElement = document.querySelector(
              ".irrigator-icon svg"
            );
            if (irrigatorElement) {
              irrigatorElement.style.transform = `rotate(${pathAngle}deg)`;
              irrigatorElement.style.transformOrigin = "center center";
            }
          }, 10);

          // Reset watered areas to zero at the start position
          leftIrrigationActive = false;
          rightIrrigationActive = false;

          // Hide both sprinkler animations
          const irrigatorIconElement =
            document.querySelector(".irrigator-icon");
          if (irrigatorIconElement) {
            irrigatorIconElement.classList.remove(
              "left-irrigation-active",
              "right-irrigation-active"
            );
          }

          // Reset left watered area to start position
          const resetLeftWateredAreaCoords = [
            leftSetCoordinates[3], // D
            leftSetCoordinates[0], // A
            leftSetCoordinates[0], // A (no area)
            leftSetCoordinates[3], // D (no area)
          ];
          leftWateredArea.setLatLngs(resetLeftWateredAreaCoords);
          leftWateredArea.setStyle({ fillOpacity: 0 });

          // Reset right watered area to start position
          const resetRightWateredAreaCoords = [
            rightSetCoordinates[0],
            rightSetCoordinates[3],
            rightSetCoordinates[3],
            rightSetCoordinates[0],
          ];
          rightWateredArea.setLatLngs(resetRightWateredAreaCoords);
          rightWateredArea.setStyle({ fillOpacity: 0 });

          currentStep = 0;
        });

      // Show start/end points visually
      const startMarker = L.circleMarker(startPoint, {
        color: "green",
        radius: 5,
        fillOpacity: 0.5,
      })
        .addTo(map)
        .bindTooltip("Start Position", { permanent: false });

      const endMarker = L.circleMarker(endPoint, {
        color: "red",
        radius: 5,
        fillOpacity: 0.5,
      })
        .addTo(map)
        .bindTooltip("End Position", { permanent: false });
    </script>
  </body>
</html>
